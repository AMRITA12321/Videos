<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ভিডিও প্ল্যাটফর্ম — Main</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--accent:#0b74de;--muted:#666}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#111;color:#fff}
    header .brand{font-weight:700}
    nav a{color:#ddd;margin:0 8px;text-decoration:none}
    .container{max-width:1100px;margin:18px auto;padding:0 12px}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:14px}
    .card{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 1px 6px rgba(0,0,0,0.06)}
    .feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .video-thumb img{width:100%;height:160px;object-fit:cover;border-radius:8px}
    .video-meta{padding:8px}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#eee;color:#111}
    .small{font-size:13px;color:var(--muted)}
    #player-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:60}
    #player-wrap{position:relative;max-width:90vw;width:100%;max-height:90vh}
    video{width:100%;height:auto;background:#000;border-radius:8px}
    #player-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;pointer-events:none}
    .hidden{display:none}
    .ad-slot{background:#111;color:#fff;padding:8px;border-radius:6px;text-align:center}
    label{display:block;margin-top:8px;font-weight:600}
    input[type="text"], textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
    footer{margin-top:18px;padding:10px;text-align:center;color:var(--muted)}
    @media(max-width:900px){ .layout{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="brand">ভিডিও প্ল্যাটফর্ম</div>
    <nav>
      <a href="#home" onclick="showTab('home')">Home</a>
      <a href="#trending" onclick="showTab('trending')">Trending</a>
      <a href="#links" onclick="showTab('links')">Uploaded Links</a>
    </nav>
    <div>
      <button id="btn-login" class="btn secondary">Login</button>
      <button id="btn-upload" class="btn">Upload</button>
    </div>
  </header>

  <main class="container">
    <div class="layout">
      <!-- Main feed -->
      <section>
        <div id="status" class="card small">Connecting...</div>

        <div id="home-section" class="card">
          <h3>Home</h3>
          <!-- Site-wide ad injected by admin (position: top) -->
          <div id="site-ad-top" class="ad-slot small" style="margin-bottom:10px">Ad slot (admin controlled)</div>

          <div id="feed" class="feed"></div>
        </div>

        <div id="links-section" class="card hidden" style="margin-top:12px">
          <h3>Uploaded Links</h3>
          <div id="links-list"></div>
          <hr/>
          <div>
            <label>Paste external video link</label>
            <input id="external-url" type="text" placeholder="https://..." />
            <div style="margin-top:8px">
              <button id="btn-add-link" class="btn">Add Link</button>
              <button id="btn-fetch-meta" class="btn secondary">Fetch Metadata</button>
            </div>
            <div id="link-meta" class="small" style="margin-top:8px"></div>
          </div>
        </div>

        <footer>© Video Platform — Demo</footer>
      </section>

      <!-- Sidebar -->
      <aside>
        <div class="card">
          <h4>Profile</h4>
          <div id="profile-area"><div class="small">Not logged in</div></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Upload Video</h4>
          <label>Title</label>
          <input id="upload-title" type="text" placeholder="Video title" />
          <label>Description</label>
          <textarea id="upload-desc" rows="3"></textarea>
          <label>File</label>
          <input id="upload-file" type="file" accept="video/*" />
          <div style="margin-top:8px">
            <button id="btn-start-upload" class="btn">Upload</button>
          </div>
          <div id="upload-progress" class="small" style="margin-top:8px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Admin Ad Preview</h4>
          <div id="site-ad-side" class="ad-slot small">Ad slot (admin)</div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Player Modal -->
  <div id="player-modal" aria-hidden="true">
    <div id="player-wrap" class="card">
      <video id="player" playsinline webkit-playsinline controlslist="nodownload"></video>
      <div id="player-overlay">Click to show controls</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btn-like" class="btn">Like</button>
        <button id="btn-comment" class="btn secondary">Comment</button>
        <button id="btn-share" class="btn secondary">Share</button>
      </div>
      <!-- video-level ad placeholder -->
      <div id="video-ad-slot" class="ad-slot small" style="margin-top:8px">Video ad (admin-controlled)</div>
      <div style="position:absolute;left:10px;top:10px"><button id="close-player" class="btn secondary">Close</button></div>
    </div>
  </div>

  <!-- templates -->
  <template id="video-card-tpl">
    <div class="card">
      <div class="video-thumb"><img class="thumb" src="" alt="thumb"/></div>
      <div class="video-meta">
        <div class="title strong"></div>
        <div class="small meta-line"></div>
      </div>
    </div>
  </template>

  <!-- Firebase & App Logic -->
  <script type="module">
  // ---------- FIREBASE CONFIG (you provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBIwk_zUPiVrMtPGSh7AVTjO_zgUCt2dp8",
    authDomain: "videos-37e8f.firebaseapp.com",
    databaseURL: "https://videos-37e8f-default-rtdb.firebaseio.com",
    projectId: "videos-37e8f",
    storageBucket: "videos-37e8f.firebasestorage.app",
    messagingSenderId: "518714664903",
    appId: "1:518714664903:web:691c37e0e9978607cadbe2",
    measurementId: "G-FDY9ZRJZFD"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore.js";
  import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-storage.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM elements
  const statusEl = document.getElementById('status');
  const feedEl = document.getElementById('feed');
  const tpl = document.getElementById('video-card-tpl');
  const profileArea = document.getElementById('profile-area');
  const btnLogin = document.getElementById('btn-login');
  const btnStartUpload = document.getElementById('btn-start-upload');
  const uploadFile = document.getElementById('upload-file');
  const uploadTitle = document.getElementById('upload-title');
  const uploadDesc = document.getElementById('upload-desc');
  const uploadProgress = document.getElementById('upload-progress');
  const playerModal = document.getElementById('player-modal');
  const player = document.getElementById('player');
  const playerOverlay = document.getElementById('player-overlay');
  const closePlayer = document.getElementById('close-player');
  const siteAdTop = document.getElementById('site-ad-top');
  const siteAdSide = document.getElementById('site-ad-side');
  const videoAdSlot = document.getElementById('video-ad-slot');

  let currentUser = null;
  let currentPlayingId = null;
  let adsDocUnsub = null; // to hold real-time listener

  // show/hide tabs
  function showTab(name){
    document.getElementById('home-section').classList.toggle('hidden', name!=='home');
    document.getElementById('links-section').classList.toggle('hidden', name!=='links');
    document.getElementById('trending-section')?.classList.toggle('hidden', name!=='trending');
  }

  // ---------- Auth handlers ----------
  btnLogin.addEventListener('click', async ()=>{
    if (currentUser){ await signOut(auth); return; }
    const useGoogle = confirm('Sign in with Google? Cancel for Email flow.');
    if (useGoogle){
      try { await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch(e){ alert('Google sign-in failed: '+e.message); }
    } else {
      const email = prompt('Email:'); if(!email) return;
      const pw = prompt('Password: (6+ chars)'); if(!pw) return;
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch(err){
        // try signup
        try { await createUserWithEmailAndPassword(auth, email, pw); alert('Account created and signed in'); }
        catch(e2){ alert('Auth error: '+e2.message); }
      }
    }
  });

  onAuthStateChanged(auth, async user=>{
    currentUser = user;
    if (user){
      btnLogin.textContent = 'Logout';
      await ensureUserDoc(user);
      renderProfile(user);
    } else {
      btnLogin.textContent = 'Login';
      profileArea.innerHTML = '<div class="small">Not logged in</div>';
    }
  });

  async function ensureUserDoc(user){
    const uRef = doc(db,'users',user.uid);
    const uSnap = await getDoc(uRef);
    if (!uSnap.exists()){
      await setDoc(uRef, { displayName: user.displayName||'', email: user.email||'', role:'user', createdAt: serverTimestamp() });
    }
  }

  async function renderProfile(user){
    const uSnap = await getDoc(doc(db,'users',user.uid));
    const data = uSnap.exists()? uSnap.data() : {};
    profileArea.innerHTML = `<div><strong>${data.displayName || user.email || 'User'}</strong></div><div class="small">${user.email||''}</div><div style="margin-top:8px" class="small">UID: ${user.uid}</div>`;
  }

  // ---------- Load feed from Firestore ----------
  async function loadFeed(){
    statusEl.textContent = 'Loading videos...';
    try {
      const q = query(collection(db,'videos'), where('visibility','==','public'), orderBy('createdAt','desc'));
      const snaps = await getDocs(q);
      feedEl.innerHTML = '';
      snaps.forEach(snap=>{
        const v = snap.data();
        feedEl.appendChild(makeVideoCard(snap.id, v));
      });
      statusEl.textContent = 'Videos loaded';
    } catch(e){
      statusEl.textContent = 'Failed to load videos: '+e.message;
      // show placeholders
      feedEl.innerHTML = '';
      for (let i=1;i<=6;i++){
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<div class="video-thumb"><img src="https://picsum.photos/seed/${i}/480/270" /></div><div class="video-meta"><div class="title">Placeholder ${i}</div></div>`;
        feedEl.appendChild(card);
      }
    }
  }

  function makeVideoCard(id, v){
    const node = tpl.content.cloneNode(true);
    const el = node.querySelector('.card');
    const img = el.querySelector('.thumb');
    const title = el.querySelector('.title');
    const meta = el.querySelector('.meta-line');
    img.src = v.thumbnail || `https://picsum.photos/seed/${id}/480/270`;
    title.textContent = v.title || 'Untitled';
    meta.textContent = `${v.views||0} views • ${v.likes||0} likes`;
    img.addEventListener('click', ()=> openPlayerForVideo(id, v));
    return el;
  }

  // ---------- Player & Video play ----------
  async function openPlayerForVideo(id, v){
    currentPlayingId = id;
    try {
      let src = null;
      if (v.type === 'external' && v.externalLink) src = v.externalLink;
      else if (v.storagePath) {
        src = await getDownloadURL(sref(storage, v.storagePath));
      } else { alert('No source'); return; }
      openPlayer(src, id, v);
    } catch(e){ alert('Play error: '+e.message); }
  }

  function openPlayer(src, id, v){
    player.src = src;
    player.currentTime = 0;
    playerModal.style.display = 'flex';
    playerOverlay.style.display = 'flex';
    player.controls = false;
    // increment view
    updateDoc(doc(db,'videos',id), { views: increment(1) }).catch(()=>{});
    // if admin set video-level ad for this video, show it (handled by ads listener)
  }

  player.addEventListener('click', function onClickOnce(){
    player.controls = true;
    playerOverlay.style.display = 'none';
    player.removeEventListener('click', onClickOnce);
  });

  closePlayer.addEventListener('click', ()=> {
    player.pause(); player.src=''; playerModal.style.display='none';
    currentPlayingId = null;
  });

  // like/comment/share simple flows
  document.getElementById('btn-like').addEventListener('click', async ()=>{
    if (!currentUser) return alert('Login to like');
    if (!currentPlayingId) return;
    try { await updateDoc(doc(db,'videos',currentPlayingId), { likes: increment(1) }); alert('Liked'); }
    catch(e){ alert('Like failed: '+e.message); }
  });

  document.getElementById('btn-comment').addEventListener('click', async ()=>{
    if (!currentUser) return alert('Login to comment');
    if (!currentPlayingId) return;
    const text = prompt('Your comment:'); if (!text) return;
    try { await addDoc(collection(db,'comments'), { videoId: currentPlayingId, authorId: currentUser.uid, text, createdAt: serverTimestamp() });
      await updateDoc(doc(db,'videos',currentPlayingId), { commentsCount: increment(1) }); alert('Comment posted'); }
    catch(e){ alert('Comment failed: '+e.message); }
  });

  document.getElementById('btn-share').addEventListener('click', ()=>{
    if (!currentPlayingId) return;
    const link = location.origin + location.pathname + '?v=' + currentPlayingId;
    navigator.clipboard?.writeText(link).then(()=> alert('Link copied to clipboard'));
  });

  // ---------- Upload flow ----------
  btnStartUpload.addEventListener('click', async ()=>{
    if (!currentUser) return alert('Login to upload');
    const file = uploadFile.files[0];
    const title = uploadTitle.value.trim();
    const desc = uploadDesc.value.trim();
    if (!file || !title) return alert('File and title required');
    try {
      uploadProgress.textContent = 'Starting...';
      const vidId = 'vid_' + Date.now();
      const path = `videos/${currentUser.uid}/${vidId}/${file.name}`;
      const ref = sref(storage, path);
      const task = uploadBytesResumable(ref, file);
      task.on('state_changed', snap=>{
        const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
        uploadProgress.textContent = `Uploading ${pct}%`;
      }, err => { uploadProgress.textContent = 'Upload error: '+err.message }, async ()=>{
        const url = await getDownloadURL(task.snapshot.ref);
        // create video doc
        const videoDoc = {
          ownerId: currentUser.uid,
          title,
          description: desc,
          storagePath: path,
          thumbnail: null,
          type: 'upload',
          createdAt: serverTimestamp(),
          visibility: 'public',
          views: 0,
          likes: 0,
          commentsCount: 0,
          adsEnabled: false,
          adConfig: {}
        };
        await setDoc(doc(db,'videos',vidId), videoDoc);
        uploadProgress.textContent = 'Upload complete';
        uploadTitle.value=''; uploadDesc.value=''; uploadFile.value='';
        await loadFeed();
      });
    } catch(e){ uploadProgress.textContent = 'Upload failed: '+e.message; }
  });

  // ---------- External link handling ----------
  document.getElementById('btn-add-link').addEventListener('click', async ()=>{
    if (!currentUser) return alert('Login to add link');
    const url = document.getElementById('external-url').value.trim(); if (!url) return alert('Enter URL');
    const title = prompt('Title for the link:') || 'External video';
    const vidId = 'vid_' + Date.now();
    await setDoc(doc(db,'videos',vidId), {
      ownerId: currentUser.uid,
      title,
      description: '',
      storagePath: '',
      externalLink: url,
      thumbnail: null,
      type: 'external',
      createdAt: serverTimestamp(),
      visibility: 'public',
      views: 0,
      likes: 0,
      commentsCount: 0,
      adsEnabled: false,
      adConfig: {}
    });
    alert('Link added'); document.getElementById('external-url').value='';
    loadFeed();
  });

  document.getElementById('btn-fetch-meta').addEventListener('click', async ()=>{
    const url = document.getElementById('external-url').value.trim(); if (!url) return alert('Enter URL');
    // Fetching OG tags client-side often fails due to CORS — instruct user
    try {
      const res = await fetch(url, { mode: 'cors' });
      const html = await res.text();
      const titleMatch = html.match(/<meta\\s+property=["']og:title["']\\s+content=["']([^"']+)["']/i) || html.match(/<title>([^<]+)<\\/i);
      const imgMatch = html.match(/<meta\\s+property=["']og:image["']\\s+content=["']([^"']+)["']/i);
      const t = titleMatch ? titleMatch[1] : '(no title)';
      const im = imgMatch ? imgMatch[1] : null;
      document.getElementById('link-meta').textContent = `Title: ${t}${im ? ' (thumbnail found)' : ''}`;
    } catch(e){
      document.getElementById('link-meta').textContent = 'Metadata fetch blocked by CORS. Use server-side metadata or paste manually.';
    }
  });

  // ---------- Admin-controlled ads: real-time listener ----------
  // admin sets doc at collection 'admin' doc 'ads'
  function startAdsListener(){
    const adsRef = doc(db,'admin','ads');
    if (adsDocUnsub) adsDocUnsub();
    // real-time listener
    adsDocUnsub = onSnapshot(adsRef, (snap)=>{
      if (!snap.exists()) {
        siteAdTop.innerHTML = 'Ad slot (admin controlled)';
        siteAdSide.innerHTML = 'Ad slot (admin controlled)';
        videoAdSlot.innerHTML = 'Video ad (admin-controlled)';
        return;
      }
      const data = snap.data();
      // Site-wide HTML injection
      if (data.enabled && data.html && data.position && data.position.includes('site')) {
        // CAUTION: we inject admin HTML as-is. Only admins should have write access.
        siteAdTop.innerHTML = data.html;
        siteAdSide.innerHTML = data.html;
      } else {
        siteAdTop.innerHTML = 'Ad slot (admin controlled)';
        siteAdSide.innerHTML = 'Ad slot (admin controlled)';
      }
      // Video-level ad: if vastTag present & enabled, show notice and store for when video plays
      if (data.enabled && data.vastTag && data.position && data.position.includes('video')) {
        // store in global variable to be used when video plays
        window.ADMIN_VIDEO_AD = data.vastTag;
        videoAdSlot.innerHTML = 'Video ad configured (will play on video start)';
      } else {
        window.ADMIN_VIDEO_AD = null;
        if (!data.html) videoAdSlot.innerHTML = 'Video ad (admin-controlled)';
      }
    }, err => { console.warn('ads listener error', err); });
  }

  // Show ads for playing video (simulated for VAST)
  async function showAdminVideoAdIfAny(){
    const vast = window.ADMIN_VIDEO_AD;
    if (!vast) return;
    // In production: integrate IMA SDK or video.js VAST plugin. Here we simulate a 3s ad overlay.
    const prevPaused = player.paused;
    player.pause();
    const old = videoAdSlot.innerHTML;
    videoAdSlot.innerHTML = 'Playing ad...';
    await new Promise(r=>setTimeout(r,3000));
    videoAdSlot.innerHTML = old;
    if (!prevPaused) player.play();
  }

  // attach to player play event
  player.addEventListener('play', ()=> {
    // when playback starts, if admin video ad present, play it once
    showAdminVideoAdIfAny().catch(()=>{});
  });

  // ---------- Start ----------
  loadFeed();
  startAdsListener();

  // handle ?v= query for open by id
  (async ()=>{
    const qp = new URLSearchParams(location.search);
    const vid = qp.get('v') || qp.get('embed');
    if (!vid) return;
    try {
      const vdoc = await getDoc(doc(db,'videos',vid));
      if (vdoc.exists()) openPlayerForVideo(vid, vdoc.data());
    } catch(e){ console.warn('open by id fail', e) }
  })();

  // expose for debug
  window.loadFeed = loadFeed;
  </script>
</body>
</html>